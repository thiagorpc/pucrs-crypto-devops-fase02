###############################################
# File: .github/workflows/007_security_dast.yml
# Name: 007. Security DAST - ZAP Scan & SonarQube Import ðŸ›¡ï¸ðŸ“Š
###############################################

name: 007. Security DAST - ZAP Scan & SonarQube Import ðŸ›¡ï¸ðŸ“Š

on:
  # Permite execuÃ§Ã£o manual com confirmaÃ§Ã£o
  workflow_dispatch:
    inputs:
      confirm_dast:
        description: "ConfirmaÃ§Ã£o de DAST Scan: Digite 'dast' para continuar."
        required: true
        default: ""
        type: string

  # Executa automaticamente apÃ³s o deploy do frontend
  workflow_run:
    workflows: ['006. Frontend CD - Deploy UI']
    types:
      - completed

permissions:
  id-token: write
  contents: read
  # issues: omitido propositalmente â†’ evita criaÃ§Ã£o automÃ¡tica de Issue no repositÃ³rio

concurrency:
  group: zap_dast_scan
  cancel-in-progress: false

env:
  AWS_REGION: us-east-1
  APIGW_NAME: pucrs-crypto-api-gateway
  SONAR_HOST_URL: https://sonarqube.academylam.net
  SARIF_API_REPORT: zap-api-report.sarif

jobs:
  zap_dast_scan:
    name: ðŸ›¡ï¸ Run DAST Scan & Import SonarQube
    runs-on: ubuntu-latest

    if: >
      ${{ (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
          (github.event_name == 'workflow_dispatch' && github.event.inputs.confirm_dast == 'dast') }}

    steps:
      - name: ðŸ“¦ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ðŸ” CONFIGURAÃ‡ÃƒO AWS
      - name: ðŸ” Configurar Credenciais AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # ðŸŽ¯ Obter URLs dinÃ¢micas (CloudFront + API Gateway)
      - name: ðŸŽ¯ Obter Domain Name do CloudFront
        id: get_cdn_domain
        run: |
          CDN_DOMAIN=$(aws cloudfront list-distributions \
            --query "DistributionList.Items[?Comment=='CDN para o frontend React no S3'].DomainName" \
            --output text \
            --region us-east-1)
          if [ -z "$CDN_DOMAIN" ]; then echo "âŒ Erro: DistribuiÃ§Ã£o CloudFront nÃ£o encontrada."; exit 1; fi
          echo "CDN_URL=https://$CDN_DOMAIN" >> $GITHUB_ENV
          echo "âœ… CloudFront Domain: https://$CDN_DOMAIN"

      - name: ðŸŽ¯ Obter DNS do API Gateway
        id: get_api_gateway_dns
        run: |
          APIGW_ID=$(aws apigateway get-rest-apis \
            --region ${{ env.AWS_REGION }} \
            --query "items[?name=='${{ env.APIGW_NAME }}'] | [0].id" \
            --output text)
          if [ -z "$APIGW_ID" ]; then echo "âŒ Erro: API Gateway ID nÃ£o encontrado."; exit 1; fi
          APIGW_STAGE="prod"
          APIGW_DNS_NAME="${APIGW_ID}.execute-api.${{ env.AWS_REGION }}.amazonaws.com/${APIGW_STAGE}"
          echo "APIGW_URL=https://$APIGW_DNS_NAME" >> $GITHUB_ENV
          echo "âœ… API Gateway DNS: https://$APIGW_DNS_NAME"

      # ðŸ’¥ VARREDURA ZAP VIA DOCKER (sem criar issue)
      - name: ðŸ”Ž Run ZAP Full Scan - API (CLI Mode)
        run: |
          echo "ðŸš€ Iniciando ZAP Full Scan..."
          docker run -v $(pwd):/zap/wrk/:rw --rm owasp/zap2docker-stable zap-full-scan.py \
            -t ${{ env.APIGW_URL }} \
            -r zap-api-report.html \
            -J zap-api-report.json \
            -a -m 5 -I
          echo "âœ… Scan finalizado. RelatÃ³rios: HTML e JSON gerados."

      # âœ… Converter relatÃ³rio JSON â†’ SARIF
      - name: ðŸ”„ Converter ZAP JSON para SARIF (CLI)
        run: |
          echo "âš™ï¸ Instalando zap2sarif..."
          pip install zap2sarif
          echo "ðŸ”„ Convertendo JSON para SARIF..."
          zap2sarif zap-api-report.json --output ${{ env.SARIF_API_REPORT }}
          echo "âœ… ConversÃ£o concluÃ­da: ${{ env.SARIF_API_REPORT }}"

      # ðŸ’» Scan ZAP do Frontend (CloudFront)
      - name: ðŸ”Ž Run ZAP Baseline Scan - Frontend (CloudFront)
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: ${{ env.CDN_URL }}
          cmd_options: '-a'
          report_name: 'zap-report-frontend.html'

      # ðŸ“¤ Upload dos RelatÃ³rios
      - name: ðŸ“¤ Upload RelatÃ³rios ZAP
        uses: actions/upload-artifact@v4
        with:
          name: zap-dast-reports
          path: |
            zap-api-report.html
            zap-api-report.json
            zap-report-frontend.html
            ${{ env.SARIF_API_REPORT }}

      # ðŸ§­ VerificaÃ§Ã£o de relatÃ³rios antes do SonarQube
      - name: ðŸ§­ Verificar relatÃ³rios gerados
        run: |
          echo "ðŸ“ Verificando relatÃ³rios..."
          ls -l zap-api-report.html zap-api-report.json ${{ env.SARIF_API_REPORT }} || echo "âš ï¸ Algum relatÃ³rio nÃ£o encontrado"
          ls -l dependency-check-report.xml || echo "âš ï¸ dependency-check-report.xml nÃ£o encontrado"

      # ðŸ“Š Importar relatÃ³rios no SonarQube
      - name: ðŸ“Š Importar RelatÃ³rios de SeguranÃ§a (ZAP + Dependency Check)
        uses: SonarSource/sonarqube-scan-action@v6.0.0
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.host.url=${{ env.SONAR_HOST_URL }}
            -Dsonar.token=${{ secrets.SONAR_TOKEN }}
            -Dsonar.projectKey=pucrs-crypto-api
            -Dsonar.sources=crypto-api/src
            -Dsonar.externalIssuesReportPaths=zap-api-report.sarif,dependency-check-report.xml
            -Dsonar.sourceEncoding=UTF-8
            -Dsonar.log.level=INFO

      # ðŸ§¾ Publicar resumo no GitHub Actions
      - name: ðŸ§¾ Publicar Resumo do DAST
        if: always()
        run: |
          {
            echo "## ðŸ›¡ï¸ DAST Scan Summary"
            echo ""
            echo "âœ… **Scan concluÃ­do com sucesso!**"
            echo "- Alvo Frontend (CloudFront): ${{ env.CDN_URL }}"
            echo "- Alvo Backend (API Gateway): ${{ env.APIGW_URL }}"
            echo "- RelatÃ³rios gerados: \`zap-api-report.html\`, \`zap-api-report.json\`, \`zap-api-report.sarif\`"
            echo "- ImportaÃ§Ã£o SonarQube: **ConcluÃ­da** (SARIF + Dependency Check)"
            echo ""
            echo "ðŸ”— [Ver artefatos do ZAP DAST no Job](./)"
          } >> $GITHUB_STEP_SUMMARY
