name: 007. Security DAST - OWASP ZAP Scan ðŸ›¡ï¸

on:
  # O scan deve rodar APÃ“S o deploy do frontend e backend
  # Ajuste '006. Frontend CD - Deploy UI' para o workflow que executa o deploy final
  workflow_run:
    workflows: ['006. Frontend CD - Deploy UI']
    types:
      - completed

concurrency:
  group: zap_dast_scan
  cancel-in-progress: false

env:
  AWS_REGION: us-east-1
  APIGW_NAME: pucrs-crypto-api-gateway
  # Defina aqui quaisquer variÃ¡veis adicionais que suas consultas AWS dependam
  # S3_FRONTEND_BUCKET: pucrs-crypto-frontend

jobs:
  zap_dast_scan:
    name: ðŸ›¡ï¸ Run DAST Scans (Frontend & API)
    runs-on: ubuntu-latest

    # âœ… SÃ³ roda se o deploy terminou com sucesso
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: ðŸ“¦ Checkout
        uses: actions/checkout@v4
      
      # ðŸ” CONFIGURAÃ‡ÃƒO AWS
      # Credenciais sÃ£o necessÃ¡rias para buscar as URLs dinÃ¢micas dos recursos.
      - name: ðŸ” Configurar Credenciais AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # ðŸŽ¯ OBTENÃ‡ÃƒO DE URLS DINÃ‚MICAS
      # 1. ObtÃ©m o EndereÃ§o do CloudFront (Frontend)
      - name: ðŸŽ¯ Obter Domain Name do CloudFront
        id: get_cdn_domain
        run: |
          # Use a query que vocÃª jÃ¡ tem para encontrar o domÃ­nio CloudFront
          CDN_DOMAIN=$(aws cloudfront list-distributions \
            --query "DistributionList.Items[?Comment=='CDN para o frontend React no S3'].DomainName" \
            --output text \
            --region us-east-1)

          if [ -z "$CDN_DOMAIN" ]; then
            echo "âŒ Erro: DistribuiÃ§Ã£o CloudFront nÃ£o encontrada. NÃ£o Ã© possÃ­vel escanear o Frontend."
            # Se a URL nÃ£o for encontrada, a variÃ¡vel nÃ£o Ã© definida, ou podemos forÃ§ar o erro
            exit 1 
          fi

          echo "CDN_URL=https://$CDN_DOMAIN" >> $GITHUB_ENV
          echo "âœ… CloudFront Domain: https://$CDN_DOMAIN"

      # 2. ObtÃ©m o EndereÃ§o do API Gateway (Backend)
      - name: ðŸŽ¯ Obter DNS do API Gateway
        id: get_api_gateway_dns
        run: |
          APIGW_ID=$(aws apigateway get-rest-apis \
            --region ${{ env.AWS_REGION }} \
            --query "items[?name=='${{ env.APIGW_NAME }}'].id" \
            --output text)

          if [ -z "$APIGW_ID" ]; then
            echo "âŒ Erro: NÃ£o foi possÃ­vel encontrar o ID para o API Gateway ${{ env.APIGW_NAME }}."
            exit 1
          fi

          APIGW_STAGE="prod"
          APIGW_DNS_NAME="${APIGW_ID}.execute-api.${{ env.AWS_REGION }}.amazonaws.com/${APIGW_STAGE}"
          echo "APIGW_URL=https://$APIGW_DNS_NAME" >> $GITHUB_ENV
          echo "âœ… API Gateway DNS: https://$APIGW_DNS_NAME"
      
      # ðŸ’¥ VARREDURAS DE SEGURANÃ‡A (OWASP ZAP)

      # 3. Scan ZAP para o FRONTEND (CloudFront)
      - name: ðŸ”Ž Run ZAP Baseline Scan - Frontend (CloudFront)
        uses: zaproxy/action-baseline@v0.12.0
        with:
          # Usa a variÃ¡vel de ambiente do CloudFront
          target: ${{ env.CDN_URL }}
          rules_file_name: '.zap/rules.tsv' # Opcional: Arquivo de regras personalizadas
          cmd_options: '-a'
          # Gera o relatÃ³rio com um nome distinto
          report_name: 'zap-report-frontend.html'
          
      # 4. Upload do RelatÃ³rio do Frontend
      - name: ðŸ“¤ Upload ZAP Report - Frontend
        uses: actions/upload-artifact@v4
        with:
          name: zap-report-frontend
          path: zap-report-frontend.html

      # 5. Scan ZAP para a API (API Gateway)
      # Nota: Para APIs mais complexas, vocÃª pode precisar do Full Scan e de um arquivo OpenAPI/Swagger
      - name: ðŸ”Ž Run ZAP Baseline Scan - API (API Gateway)
        uses: zaproxy/action-baseline@v0.12.0
        with:
          # Usa a variÃ¡vel de ambiente do API Gateway
          target: ${{ env.APIGW_URL }}
          rules_file_name: '.zap/rules.tsv' 
          cmd_options: '-a'
          # Gera o relatÃ³rio com um nome distinto
          report_name: 'zap-report-api.html'

      # 6. Upload do RelatÃ³rio da API
      - name: ðŸ“¤ Upload ZAP Report - API
        uses: actions/upload-artifact@v4
        with:
          name: zap-report-api
          path: zap-report-api.html

      # ðŸ’¬ RESUMO FINAL
      - name: ðŸ§¾ Publicar Resumo do DAST
        if: always()
        run: |
          {
            echo "## ðŸ›¡ï¸ DAST Scan Summary"
            echo "- Scan ConcluÃ­do: âœ…"
            echo "- Alvo Frontend (CloudFront): ${CDN_URL}"
            echo "- Alvo Backend (API Gateway): ${APIGW_URL}"
            echo "- RelatÃ³rios disponÃ­veis como Artifacts: \`zap-report-frontend\` e \`zap-report-api\`"
          } >> $GITHUB_STEP_SUMMARY