###############################################
# File: .github/workflows/007_security_dast.yml
# Name: 007. Security DAST - ZAP Scan & SonarQube Import ðŸ›¡ï¸ðŸ“Š
###############################################

name: 007. Security DAST - ZAP Scan & SonarQube Import ðŸ›¡ï¸ðŸ“Š

on:
  # Permite execuÃ§Ã£o manual com confirmaÃ§Ã£o
  workflow_dispatch:
    inputs:
      confirm_dast:
        description: "ConfirmaÃ§Ã£o de DAST Scan: Digite 'dast' para continuar."
        required: true
        default: ""
        type: string

  # Executa automaticamente apÃ³s o deploy do frontend
  workflow_run:
    workflows: ['006. Frontend CD - Deploy UI']
    types:
      - completed

concurrency:
  group: zap_dast_scan
  cancel-in-progress: false

permissions:
  contents: read
  issues: none
  pull-requests: none


env:
  AWS_REGION: us-east-1
  APIGW_NAME: pucrs-crypto-api-gateway
  SONAR_HOST_URL: https://sonarqube.academylam.net
  SARIF_API_REPORT: zap-api-report.sarif

jobs:
  zap_dast_scan:
    name: ðŸ›¡ï¸ Run DAST Scan & Import SonarQube
    runs-on: ubuntu-latest

    if: >
      ${{ (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
          (github.event_name == 'workflow_dispatch' && github.event.inputs.confirm_dast == 'dast') }}

    steps:
      - name: ðŸ“¦ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ðŸ” CONFIGURAÃ‡ÃƒO AWS
      - name: ðŸ” Configurar Credenciais AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # ðŸŽ¯ Obter URLs dinÃ¢micas para o scan
      - name: ðŸŽ¯ Obter Domain Name do CloudFront
        id: get_cdn_domain
        run: |
          CDN_DOMAIN=$(aws cloudfront list-distributions \
            --query "DistributionList.Items[?Comment=='CDN para o frontend React no S3'].DomainName" \
            --output text \
            --region us-east-1)
          if [ -z "$CDN_DOMAIN" ]; then echo "âŒ Erro: DistribuiÃ§Ã£o CloudFront nÃ£o encontrada."; exit 1; fi
          echo "CDN_URL=https://$CDN_DOMAIN" >> $GITHUB_ENV
          echo "âœ… CloudFront Domain: https://$CDN_DOMAIN"

      - name: ðŸŽ¯ Obter DNS do API Gateway
        id: get_api_gateway_dns
        run: |
          APIGW_ID=$(aws apigateway get-rest-apis \
            --region ${{ env.AWS_REGION }} \
            --query "items[?name=='${{ env.APIGW_NAME }}'] | [0].id" \
            --output text)
          if [ -z "$APIGW_ID" ]; then echo "âŒ Erro: API Gateway ID nÃ£o encontrado."; exit 1; fi
          APIGW_STAGE="prod"
          APIGW_DNS_NAME="${APIGW_ID}.execute-api.${{ env.AWS_REGION }}.amazonaws.com/${APIGW_STAGE}"
          echo "APIGW_URL=https://$APIGW_DNS_NAME" >> $GITHUB_ENV
          echo "âœ… API Gateway DNS: https://$APIGW_DNS_NAME"

      # ðŸ’¥ VARREDURA ZAP E CONVERSÃƒO PARA SONARQUBE
      #- name: ðŸ”Ž Run ZAP Full Scan - API (GeraÃ§Ã£o JSON)
      #  uses: zaproxy/action-full-scan@v0.12.0
      #  with:
      #    target: ${{ env.APIGW_URL }}
      #    output_format: json
      #    output_file: zap-api-report.json
      #    rules_file_name: '.zap/rules.tsv'
      #    time: 10 # minutos
      
      #- name: ðŸ”Ž Run ZAP Full Scan - API (GeraÃ§Ã£o JSON)
      #  uses: zaproxy/action-full-scan@v0.12.0
      #  with:
      #    target: ${{ env.APIGW_URL }}
      #    #rules_file_name: '.zap/rules.tsv'
      #    allow_issue_writing: false  # ðŸš« Desativa criaÃ§Ã£o de Issues automÃ¡ticas
      #    cmd_options: '-a -m 5'       # modo agressivo e profundidade de spider

      - name: ðŸ”Ž Run ZAP Baseline Scan - Frontend (CLI Mode)
        run: |
          echo "ðŸš€ Iniciando ZAP Baseline Scan (Frontend)..."
          docker run -v $(pwd):/zap/wrk/:rw --rm owasp/zap2docker-stable zap-baseline.py \
            -t ${{ env.CDN_URL }} \
            -r zap-report-frontend.html \
            -J zap-frontend-report.json \
            -a -m 5 -I
          echo "âœ… ZAP Baseline Scan concluÃ­do com sucesso."

      # ðŸ“¤ Upload do RelatÃ³rio do Frontend
      - name: ðŸ§¾ Publicar Resumo do DAST
        if: always()
        run: |
          {
            echo "## ðŸ›¡ï¸ DAST Scan Summary"
            echo "- Scan ConcluÃ­do: âœ…"
            echo "- Alvo Frontend (CloudFront): ${{ env.CDN_URL }}"
            echo "- Alvo Backend (API Gateway): ${{ env.APIGW_URL }}"
          } >> $GITHUB_STEP_SUMMARY
