name: 007. Security DAST - ZAP Scan & SonarQube Import ðŸ›¡ï¸ðŸ“Š

on:
  # O scan deve rodar APÃ“S o deploy do frontend e backend
  workflow_dispatch:
    inputs:
      confirm_dast:
        description: "ConfirmaÃ§Ã£o de DAST Scan: Digite 'dast' para continuar."
        required: true
        default: ""
        type: string

  workflow_run:
    workflows: ['006. Frontend CD - Deploy UI']
    types:
      - completed

concurrency:
  group: zap_dast_scan
  cancel-in-progress: false

env:
  AWS_REGION: us-east-1
  APIGW_NAME: pucrs-crypto-api-gateway
  SONAR_HOST_URL: https://sonarqube.academylam.net
  # Define o nome do arquivo SARIF para uso na etapa do SonarQube
  SARIF_API_REPORT: zap-api-report.sarif 

jobs:
  zap_dast_scan:
    name: ðŸ›¡ï¸ Run DAST Scan & Import SonarQube
    runs-on: ubuntu-latest
    
    # Adicionando condiÃ§Ã£o de sucesso do workflow_run e confirmaÃ§Ã£o manual
    if: |
      ${{ github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' }} ||
      ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.confirm_dast == 'dast' }}

    steps:
      - name: ðŸ“¦ Checkout
        uses: actions/checkout@v4
        # NecessÃ¡rio para que o SonarQube Scanner consiga mapear os sources
        with:
          fetch-depth: 0 
      
      # ðŸ” CONFIGURAÃ‡ÃƒO AWS
      - name: ðŸ” Configurar Credenciais AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # ðŸŽ¯ OBTENÃ‡ÃƒO DE URLS DINÃ‚MICAS
      # ... (Steps 1 & 2 para obter CDN_URL e APIGW_URL permanecem as mesmas)

      - name: ðŸŽ¯ Obter Domain Name do CloudFront
        id: get_cdn_domain
        run: |
          CDN_DOMAIN=$(aws cloudfront list-distributions \
            --query "DistributionList.Items[?Comment=='CDN para o frontend React no S3'].DomainName" \
            --output text \
            --region us-east-1)

          if [ -z "$CDN_DOMAIN" ]; then echo "âŒ Erro: DistribuiÃ§Ã£o CloudFront nÃ£o encontrada." ; exit 1 ; fi
          echo "CDN_URL=https://$CDN_DOMAIN" >> $GITHUB_ENV
          echo "âœ… CloudFront Domain: https://$CDN_DOMAIN"

      - name: ðŸŽ¯ Obter DNS do API Gateway
        id: get_api_gateway_dns
        run: |
          APIGW_ID=$(aws apigateway get-rest-apis \
            --region ${{ env.AWS_REGION }} \
            --query "items[?name=='${{ env.APIGW_NAME }}'].id" \
            --output text)

          if [ -z "$APIGW_ID" ]; then echo "âŒ Erro: API Gateway ID nÃ£o encontrado." ; exit 1 ; fi

          APIGW_STAGE="prod"
          APIGW_DNS_NAME="${APIGW_ID}.execute-api.${{ env.AWS_REGION }}.amazonaws.com/${APIGW_STAGE}"
          echo "APIGW_URL=https://$APIGW_DNS_NAME" >> $GITHUB_ENV
          echo "âœ… API Gateway DNS: https://$APIGW_DNS_NAME"
      
      
      # ðŸ’¥ VARREDURA ZAP E CONVERSÃƒO PARA SONARQUBE
      
      # 3. Scan ZAP para a API (Usando Full Scan e JSON)
      - name: ðŸ”Ž Run ZAP Full Scan - API (GeraÃ§Ã£o JSON)
        # Usando full-scan para API, que Ã© mais robusto que o baseline
        uses: zaproxy/action-full-scan@v0.12.0
        with:
          target: ${{ env.APIGW_URL }}
          # Especifica o formato JSON para facilitar a conversÃ£o
          output_format: json 
          output_file: zap-api-report.json
          rules_file_name: '.zap/rules.tsv' 
          # Tempo limite alto para varreduras completas
          time: 5 # 5 minutos (Ajuste conforme o tamanho da sua API)

      # 4. ConversÃ£o do RelatÃ³rio JSON ZAP para SARIF
      - name: ðŸ”„ Converter ZAP JSON para SARIF
        # Esta Action utiliza a ferramenta de conversÃ£o oficial do ZAP (ZAP to SARIF)
        uses: zaproxy/action-sarif@v0.1.0 
        with:
          zap_json_file: zap-api-report.json
          # O nome do arquivo SARIF gerado (usaremos este nome no SonarQube)
          output_file: ${{ env.SARIF_API_REPORT }} 

      # 5. Scan ZAP para o FRONTEND (CloudFront) - APENAS GERAÃ‡ÃƒO DE ARTIFACT
      # Esta etapa nÃ£o serÃ¡ importada para o SonarQube (a menos que haja um projectKey para o FE)
      - name: ðŸ”Ž Run ZAP Baseline Scan - Frontend (CloudFront)
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: ${{ env.CDN_URL }}
          cmd_options: '-a'
          report_name: 'zap-report-frontend.html'
          
      # 6. Upload do RelatÃ³rio do Frontend
      - name: ðŸ“¤ Upload ZAP Report - Frontend
        uses: actions/upload-artifact@v4
        with:
          name: zap-report-frontend
          path: zap-report-frontend.html

      # 7. ðŸ“Š SonarQube Scan & Import DAST Results
      - name: ðŸ“Š SonarQube Scan & Import DAST Results (API)
        uses: SonarSource/sonarqube-scan-action@v6.0.0
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.host.url=${{ env.SONAR_HOST_URL }}
            -Dsonar.token=${{ secrets.SONAR_TOKEN }}
            -Dsonar.projectKey=pucrs-crypto-api
            -Dsonar.sources=crypto-api/src
            # ðŸ’¡ PARÃ‚METRO CHAVE: Importa o relatÃ³rio SARIF gerado no passo 4
            -Dsonar.externalIssuesReportPaths=${{ env.SARIF_API_REPORT }}

      # 8. Upload do RelatÃ³rio SARIF (Opcional, para debug)
      - name: ðŸ“¤ Upload SARIF Report (API)
        uses: actions/upload-artifact@v4
        with:
          name: zap-report-api-sarif
          path: ${{ env.SARIF_API_REPORT }}
          
      # ðŸ’¬ RESUMO FINAL
      - name: ðŸ§¾ Publicar Resumo do DAST
        if: always()
        run: |
          {
            echo "## ðŸ›¡ï¸ DAST Scan Summary"
            echo "- Scan ConcluÃ­do: âœ…"
            echo "- Alvo Frontend (CloudFront): ${{ env.CDN_URL }}"
            echo "- Alvo Backend (API Gateway): ${{ env.APIGW_URL }}"
            echo "- ImportaÃ§Ã£o SonarQube: **SARIF concluÃ­da** para \`pucrs-crypto-api\`"
          } >> $GITHUB_STEP_SUMMARY