name: 007. Security DAST - ZAP Scan & SonarQube Import ðŸ›¡ï¸ðŸ“Š

on:
  workflow_dispatch:
    inputs:
      confirm_dast:
        description: "ConfirmaÃ§Ã£o de DAST Scan: Digite 'dast' para continuar."
        required: true
        default: ""
        type: string

  workflow_run:
    workflows: ['006. Frontend CD - Deploy UI']
    types:
      - completed

concurrency:
  group: zap_dast_scan
  cancel-in-progress: false

env:
  AWS_REGION: us-east-1
  APIGW_NAME: pucrs-crypto-api-gateway
  SONAR_HOST_URL: https://sonarqube.academylam.net
  SARIF_API_REPORT: zap-api-report.sarif

jobs:
  zap_dast_scan:
    name: ðŸ›¡ï¸ Run DAST Scan & Import SonarQube
    runs-on: ubuntu-latest

    if: >
      ${{ (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
          (github.event_name == 'workflow_dispatch' && github.event.inputs.confirm_dast == 'dast') }}

    steps:
      - name: ðŸ“¦ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Configurar Credenciais AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ðŸŽ¯ Obter Domain Name do CloudFront
        id: get_cdn_domain
        run: |
          CDN_DOMAIN=$(aws cloudfront list-distributions \
            --query "DistributionList.Items[?Comment=='CDN para o frontend React no S3'].DomainName" \
            --output text \
            --region us-east-1)
          if [ -z "$CDN_DOMAIN" ]; then echo "âŒ Erro: DistribuiÃ§Ã£o CloudFront nÃ£o encontrada."; exit 1; fi
          echo "CDN_URL=https://$CDN_DOMAIN" >> $GITHUB_ENV
          echo "âœ… CloudFront Domain: https://$CDN_DOMAIN"

      - name: ðŸŽ¯ Obter DNS do API Gateway
        id: get_api_gateway_dns
        run: |
          APIGW_ID=$(aws apigateway get-rest-apis \
            --region ${{ env.AWS_REGION }} \
            --query "items[?name=='${{ env.APIGW_NAME }}'] | [0].id" \
            --output text)
          if [ -z "$APIGW_ID" ]; then echo "âŒ Erro: API Gateway ID nÃ£o encontrado."; exit 1; fi
          APIGW_STAGE="prod"
          APIGW_DNS_NAME="${APIGW_ID}.execute-api.${{ env.AWS_REGION }}.amazonaws.com/${APIGW_STAGE}"
          echo "APIGW_URL=https://$APIGW_DNS_NAME" >> $GITHUB_ENV
          echo "âœ… API Gateway DNS: https://$APIGW_DNS_NAME"

      - name: ðŸ”Ž Run ZAP Full Scan - API (GeraÃ§Ã£o JSON)
        uses: zaproxy/action-full-scan@v0.12.0
        with:
          target: ${{ env.APIGW_URL }}
          output_format: json
          output_file: zap-api-report.json
          rules_file_name: '.zap/rules.tsv'
          time: 10

      - name: ðŸ”„ Converter ZAP JSON para SARIF
        uses: zaproxy/action-sarif@v0.1.0
        with:
          zap_json_file: zap-api-report.json
          output_file: ${{ env.SARIF_API_REPORT }}

      - name: ðŸ”Ž Run ZAP Baseline Scan - Frontend (CloudFront)
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: ${{ env.CDN_URL }}
          cmd_options: '-a'
          report_name: 'zap-report-frontend.html'

      - name: ðŸ“¤ Upload ZAP Report - Frontend
        uses: actions/upload-artifact@v4
        with:
          name: zap-report-frontend
          path: zap-report-frontend.html

      - name: ðŸ§­ Verificar relatÃ³rios gerados
        run: |
          echo "ðŸ“ Verificando relatÃ³rios antes do SonarQube..."
          ls -l zap-api-report.sarif || echo "âš ï¸ zap-api-report.sarif nÃ£o encontrado"
          ls -l dependency-check-report.xml || echo "âš ï¸ dependency-check-report.xml nÃ£o encontrado"

      - name: ðŸ“Š Importar RelatÃ³rios de SeguranÃ§a (ZAP + Dependency Check)
        uses: SonarSource/sonarqube-scan-action@v6.0.0
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.host.url=${{ env.SONAR_HOST_URL }}
            -Dsonar.token=${{ secrets.SONAR_TOKEN }}
            -Dsonar.projectKey=pucrs-crypto-api
            -Dsonar.sources=crypto-api/src
            -Dsonar.externalIssuesReportPaths=zap-api-report.sarif,dependency-check-report.xml
            -Dsonar.sourceEncoding=UTF-8
            -Dsonar.log.level=INFO

      - name: ðŸ§¾ Publicar Resumo do DAST
        if: always()
        run: |
          {
            echo "## ðŸ›¡ï¸ DAST Scan Summary"
            echo "- Scan ConcluÃ­do: âœ…"
            echo "- Alvo Frontend (CloudFront): ${{ env.CDN_URL }}"
            echo "- Alvo Backend (API Gateway): ${{ env.APIGW_URL }}"
            echo "- ImportaÃ§Ã£o SonarQube: **SARIF concluÃ­da** para \`pucrs-crypto-api\`"
          } >> $GITHUB_STEP_SUMMARY
