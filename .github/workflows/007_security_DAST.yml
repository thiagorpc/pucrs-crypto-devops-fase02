###############################################
# File: .github/workflows/007_security_dast.yml
# Name: 007. Security DAST - ZAP Scan & SonarQube Import ðŸ›¡ï¸ðŸ“Š
###############################################

name: 007. Security DAST - ZAP Scan & SonarQube Import ðŸ›¡ï¸ðŸ“Š

on:
  # Permite execuÃ§Ã£o manual com confirmaÃ§Ã£o
  workflow_dispatch:
    inputs:
      confirm_dast:
        description: "ConfirmaÃ§Ã£o de DAST Scan: Digite 'dast' para continuar."
        required: true
        default: ""
        type: string

  # Executa automaticamente apÃ³s o deploy do frontend
  workflow_run:
    workflows: ['006. Frontend CD - Deploy UI']
    types:
      - completed

concurrency:
  group: zap_dast_scan
  cancel-in-progress: false

permissions:
  contents: read
  issues: none
  pull-requests: none


env:
  AWS_REGION: us-east-1
  APIGW_NAME: pucrs-crypto-api-gateway
  SONAR_HOST_URL: https://sonarqube.academylam.net
  SARIF_API_REPORT: zap-api-report.sarif

jobs:
  zap_dast_scan:
    name: ðŸ›¡ï¸ Run DAST Scan & Import SonarQube
    runs-on: ubuntu-latest

    if: >
      ${{ (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
          (github.event_name == 'workflow_dispatch' && github.event.inputs.confirm_dast == 'dast') }}

    steps:
      - name: ðŸ“¦ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ðŸ” CONFIGURAÃ‡ÃƒO AWS
      - name: ðŸ” Configurar Credenciais AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # ðŸŽ¯ Obter URLs dinÃ¢micas para o scan
      - name: ðŸŽ¯ Obter Domain Name do CloudFront
        id: get_cdn_domain
        run: |
          CDN_DOMAIN=$(aws cloudfront list-distributions \
            --query "DistributionList.Items[?Comment=='CDN para o frontend React no S3'].DomainName" \
            --output text \
            --region us-east-1)
          if [ -z "$CDN_DOMAIN" ]; then echo "âŒ Erro: DistribuiÃ§Ã£o CloudFront nÃ£o encontrada."; exit 1; fi
          echo "CDN_URL=https://$CDN_DOMAIN" >> $GITHUB_ENV
          echo "âœ… CloudFront Domain: https://$CDN_DOMAIN"

      - name: ðŸŽ¯ Obter DNS do API Gateway
        id: get_api_gateway_dns
        run: |
          APIGW_ID=$(aws apigateway get-rest-apis \
            --region ${{ env.AWS_REGION }} \
            --query "items[?name=='${{ env.APIGW_NAME }}'] | [0].id" \
            --output text)
          if [ -z "$APIGW_ID" ]; then echo "âŒ Erro: API Gateway ID nÃ£o encontrado."; exit 1; fi
          APIGW_STAGE="prod"
          APIGW_DNS_NAME="${APIGW_ID}.execute-api.${{ env.AWS_REGION }}.amazonaws.com/${APIGW_STAGE}"
          echo "APIGW_URL=https://$APIGW_DNS_NAME" >> $GITHUB_ENV
          echo "âœ… API Gateway DNS: https://$APIGW_DNS_NAME"

      # ðŸ’¥ VARREDURA ZAP E CONVERSÃƒO PARA SONARQUBE
      #- name: ðŸ”Ž Run ZAP Full Scan - API (GeraÃ§Ã£o JSON)
      #  uses: zaproxy/action-full-scan@v0.12.0
      #  with:
      #    target: ${{ env.APIGW_URL }}
      #    output_format: json
      #    output_file: zap-api-report.json
      #    rules_file_name: '.zap/rules.tsv'
      #    time: 10 # minutos
      
      - name: ðŸ”Ž Run ZAP Full Scan - API (GeraÃ§Ã£o JSON)
        uses: zaproxy/action-full-scan@v0.12.0
        with:
          target: ${{ env.APIGW_URL }}
          rules_file_name: '.zap/rules.tsv'
          allow_issue_writing: false  # ðŸš« Desativa criaÃ§Ã£o de Issues automÃ¡ticas
          cmd_options: '-a -m 5'       # modo agressivo e profundidade de spider


      ##- name: ðŸ”„ Converter ZAP JSON para SARIF (SARIF Multitool)
      ##  run: |
      ##    echo "âš™ï¸ Instalando SARIF Multitool..."
      ##    npm install -g @microsoft/sarif-multitool
      ##    echo "ðŸ”„ Convertendo ZAP JSON â†’ SARIF..."
      ##    sarif-multitool convert zap-api-report.json --output ${{ env.SARIF_API_REPORT }}
      ##    echo "âœ… ConversÃ£o concluÃ­da: ${{ env.SARIF_API_REPORT }}"

      - name: ðŸ” Validar SARIF (opcional)
        run: |
          npm install -g @microsoft/sarif-multitool
          sarif-multitool validate ${{ env.SARIF_API_REPORT }}



      # âœ… ConversÃ£o JSON â†’ SARIF via zap2sarif
      #- name: ðŸ”„ Converter ZAP JSON para SARIF (CLI)
      #  run: |
      #    echo "âš™ï¸ Instalando zap2sarif..."
      #    pip install zap2sarif
      #    echo "ðŸ”„ Convertendo JSON para SARIF..."
      #    zap2sarif zap-api-report.json --output ${{ env.SARIF_API_REPORT }}
      #    echo "âœ… ConversÃ£o concluÃ­da: ${{ env.SARIF_API_REPORT }}"

      # ðŸ’» Scan ZAP Frontend (CloudFront)
      - name: ðŸ”Ž Run ZAP Baseline Scan - Frontend (CloudFront)
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: ${{ env.CDN_URL }}
          cmd_options: '-a'
          report_name: 'zap-report-frontend.html'
          allow_issue_writing: false  # ðŸš« Desativa criaÃ§Ã£o de Issues automÃ¡ticas

      # ðŸ“¤ Upload do RelatÃ³rio do Frontend
      - name: ðŸ“¤ Upload ZAP Report - Frontend
        uses: actions/upload-artifact@v4
        with:
          name: zap-report-frontend
          path: zap-report-frontend.html

      # ðŸ§­ VerificaÃ§Ã£o de relatÃ³rios antes do SonarQube
      - name: ðŸ§­ Verificar relatÃ³rios gerados
        run: |
          echo "ðŸ“ Verificando relatÃ³rios antes do SonarQube..."
          ls -l zap-api-report.sarif || echo "âš ï¸ zap-api-report.sarif nÃ£o encontrado"
          ls -l dependency-check-report.xml || echo "âš ï¸ dependency-check-report.xml nÃ£o encontrado"

      # ðŸ“Š Importar resultados no SonarQube
      - name: ðŸ“Š Importar RelatÃ³rios de SeguranÃ§a (ZAP + Dependency Check)
        uses: SonarSource/sonarqube-scan-action@v6.0.0
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.host.url=${{ env.SONAR_HOST_URL }}
            -Dsonar.token=${{ secrets.SONAR_TOKEN }}
            -Dsonar.projectKey=pucrs-crypto-api
            -Dsonar.sources=crypto-api/src
            -Dsonar.externalIssuesReportPaths=zap-api-report.sarif,dependency-check-report.xml
            -Dsonar.sourceEncoding=UTF-8
            -Dsonar.log.level=INFO

      # ðŸ§¾ Publicar resumo do DAST
      - name: ðŸ§¾ Publicar Resumo do DAST
        if: always()
        run: |
          {
            echo "## ðŸ›¡ï¸ DAST Scan Summary"
            echo "- Scan ConcluÃ­do: âœ…"
            echo "- Alvo Frontend (CloudFront): ${{ env.CDN_URL }}"
            echo "- Alvo Backend (API Gateway): ${{ env.APIGW_URL }}"
            echo "- ImportaÃ§Ã£o SonarQube: **SARIF concluÃ­da** para \`pucrs-crypto-api\`"
          } >> $GITHUB_STEP_SUMMARY
