name: 009. Destroy Infra AWS ğŸ’£

on:
  workflow_dispatch:
    inputs:
      # ForÃ§a a confirmaÃ§Ã£o manual da destruiÃ§Ã£o na interface do Actions
      confirm_destroy:
        description: "ConfirmaÃ§Ã£o de DestruiÃ§Ã£o: Digite 'destroy' para continuar."
        required: true
        default: ""
        type: string

concurrency:
  group: terraform
  cancel-in-progress: false

env:
  S3_STATE_BUCKET: pucrs-crypto-github-action-tfstate-unique
  DYNAMO_LOCK_TABLE: pucrs-crypto-terraform-lock
  TF_MAIN_DIR: ./iac/flow
  AWS_REGION: us-east-1

jobs:
  # ==========================================================
  # ğŸš€ JOB 2:Remove Infra AWS
  # ==========================================================
  terraform:
    name: "Terraform Destroy"
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ${{ env.TF_MAIN_DIR }}

    steps:
      # -----------------------
      # ğŸ”¹ 1. Checkout do RepositÃ³rio
      # -----------------------
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      # -----------------------
      # ğŸ”¹ 2. Setup Terraform
      # -----------------------
      - name: âš™ï¸ Configurar Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          # Use a versÃ£o mais estÃ¡vel/recente. Manter 1.5.0, mas 1.9.x Ã© melhor se possÃ­vel.
          terraform_version: 1.5.0 

      # -----------------------
      # ğŸ”¹ 3. Configurar Credenciais AWS
      # -----------------------
      - name: ğŸ” Configurar Credenciais AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}


      # -----------------------
      # ğŸ”¹ 4. Inicializar Terraform
      # -----------------------
      - name: ğŸ§± Terraform Init
        id: init
        run: terraform init -reconfigure

      # -----------------------
      # ğŸ”¹ 5. Criar Plano de DestruiÃ§Ã£o (SeguranÃ§a Operacional)
      # -----------------------
      - name: ğŸ“ Criar Plano de DestruiÃ§Ã£o
        run: terraform plan -destroy -out=tfplan.destroy
      
      # -----------------------
      # ğŸ”¹ 6. Aplicar DestruiÃ§Ã£o
      # -----------------------
      - name: ğŸ”¥ Aplicar DestruiÃ§Ã£o (Auto-Aprovar)
        run: terraform apply -auto-approve tfplan.destroy


      # -----------------------
      # ğŸ”¹ 7. Criar Plano de DestruiÃ§Ã£o (SeguranÃ§a Operacional)
      # -----------------------
      #- name: ğŸ’£ Executar Terraform Destroy
      #  id: destroy
      #  run: terraform destroy -auto-approve


      # -----------------------
      # ğŸ”¹ 8. Criar Plano de DestruiÃ§Ã£o (SeguranÃ§a Operacional)
      # -----------------------
      - name: ğŸ—‘ï¸ Excluir Tabela DynamoDB do Backend
        run: |
          echo "ğŸ—‘ï¸ Excluindo tabela DynamoDB: ${{ env.DYNAMO_LOCK_TABLE }}"
          aws dynamodb delete-table \
            --table-name ${{ env.DYNAMO_LOCK_TABLE }} \
            --region ${{ env.AWS_REGION }} || true
          echo "âœ… DynamoDB ${{ env.DYNAMO_LOCK_TABLE }} excluÃ­da (ou jÃ¡ inexistente)."


      # -----------------------
      # ğŸ”¹ 9. Criar Plano de DestruiÃ§Ã£o (SeguranÃ§a Operacional)
      # -----------------------
      - name: ğŸ§¹ Limpar e Excluir Bucket S3 (versÃµes, markers e bucket)
        run: |
          sudo apt-get update && sudo apt-get install -y jq

          BUCKET=${{ env.S3_STATE_BUCKET }}
          echo "ğŸ§¹ Deletando versÃµes e delete markers do bucket: $BUCKET"

          aws s3api list-object-versions --bucket "$BUCKET" --output json \
            | jq -r '.Versions[]?, .DeleteMarkers[]? | [.Key, .VersionId] | @tsv' \
            | while IFS=$'\t' read -r key versionId; do
                aws s3api delete-object --bucket "$BUCKET" --key "$key" --version-id "$versionId" || true
              done

          echo "ğŸª£ Excluindo bucket S3..."
          aws s3api delete-bucket --bucket "$BUCKET" --region ${{ env.AWS_REGION }} || true
          echo "âœ… Bucket S3 $BUCKET excluÃ­do com sucesso (ou jÃ¡ inexistente)."


      # -----------------------
      # ğŸ”¹ 10. Salvar um snapshot do estado atual antes do destroy, caso precise restaurar rapidamente
      # -----------------------
      - name: ğŸ’¾ Backup Terraform State
        run: |
          aws s3 cp s3://${{ env.S3_STATE_BUCKET }}/terraform.tfstate ./terraform.tfstate.backup || true
          echo "âœ… Backup do estado local salvo."


      # -----------------------
      # ğŸ”¹ 11. Criar Plano de DestruiÃ§Ã£o (SeguranÃ§a Operacional)
      # -----------------------
      - name: ğŸ‰ Notificar Sucesso
        run: echo "ğŸ‰ Infraestrutura destruÃ­da e backend AWS limpo com sucesso!"
