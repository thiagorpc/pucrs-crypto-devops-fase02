name: 004. Backend CD - Stage

on:
  workflow_dispatch:
  workflow_run:
    workflows: ['003. Backend CI - Build and Push Image']
    types:
      - completed

concurrency:
  group: terraform
  cancel-in-progress: false
  
env:
  AWS_REGION: us-east-1
  TF_WORKING_DIR: ./iac/flow
  # ‚úÖ URL do SonarQube definida globalmente
  SONAR_HOST_URL: https://sonarqube.academylam.net

jobs:
# 1. üîç FASE: An√°lise de C√≥digo (Job Inicial)
  code-analysis:
    name: üîç SonarQube Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # fetch-depth: 0 √© crucial para obter o hist√≥rico completo e rodar an√°lises de branches/PRs
          fetch-depth: 0
          
      - name: SonarQube Scan
        uses: sonarsource/sonar-scanner-cli-action@v1.2
        # N√ÉO use 'env' aqui para as vari√°veis Sonar. Use 'with' e 'args'
        with:
          # Diret√≥rio onde o c√≥digo a ser analisado est√°.
          projectBaseDir: src/crypto-api
          # ‚úÖ Passa o host e o token como argumentos do scanner
          args: >
            -Dsonar.host.url=${{ env.SONAR_HOST_URL }}
            -Dsonar.token=${{ secrets.SONAR_TOKEN }}
            -Dsonar.projectKey=crypto-api-project # Sugest√£o: Adicione a chave do seu projeto
            
# 2. üõ°Ô∏è FASE: Teste de Seguran√ßa (Depende da An√°lise de C√≥digo)
# ... (Este job est√° comentado e n√£o afeta a execu√ß√£o atual)